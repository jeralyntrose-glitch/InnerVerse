# Overview

InnerVerse is a FastAPI-based PDF Q&A application that provides intelligent answers from uploaded PDF documents. It features a modern web interface with drag-and-drop upload capabilities, processes documents by chunking and embedding their content, stores these embeddings in Pinecone, and leverages OpenAI's GPT models for answering user queries based on the document content. The application aims to offer an intuitive user experience for document interaction and knowledge retrieval, including the ability to transcribe audio files and YouTube videos into searchable PDFs and generate document reports. The project also includes robust API usage monitoring with real-time cost tracking and rate limiting.

# User Preferences

Preferred communication style: Simple, everyday language.

# Portfolio-Worthy Project Stories

## YouTube Transcription: Smart Pivot Under Technical Constraints

**Challenge:** Need to transcribe 321 CS Joseph YouTube videos on MBTI/Jungian psychology for a knowledge base project. Initial approach using Whisper API ($0.006/min) worked for ~160 videos before hitting YouTube's aggressive anti-bot detection systems.

**Technical Blockers Encountered:**
1. **Datacenter IP Blocking:** YouTube blocks Replit's cloud IPs from downloading videos
2. **Residential Proxy Detection:** Tested Decodo residential proxies with HTTP, HTTPS, and SOCKS5 protocols - all blocked with 403 Forbidden errors during download phase
3. **Proxy Authentication Success But Download Failure:** Proxies authenticated successfully and retrieved metadata, but YouTube detected and blocked actual audio downloads

**Solution/Pivot:**
After discovering YouTube blocks ALL cloud provider IPs (AWS, GCP, Azure, Replit, etc.) industry-wide, pivoted to manual workflow that preserves cost savings:
- **Manual transcript copy** from YouTube's "Show transcript" button (still works in browser)
- **Text to PDF conversion** with GPT-3.5 cleanup for punctuation, capitalization, and grammar (~$0.001-0.002 per video)
- **Auto-tagging** with MBTI/Jungian taxonomy via standard PDF upload pipeline
- **Pinecone indexing** for semantic search across all transcripts

**Final Workflow:** (1) Click "Show transcript" on YouTube → (2) Copy text → (3) Convert via Text to PDF → (4) Upload PDF for tagging/indexing

**Results:**
- **Cost Reduction:** $44.30 → $0.64 for 321 videos (70x cheaper, ~98.5% cost savings vs. Whisper)
- **Quality Control:** Ability to review PDFs before indexing and maintain local backups
- **Reliability:** Works around YouTube's cloud IP blocking (confirmed industry-wide issue affecting all providers)
- **Quality:** Comparable quality (YouTube's transcription + GPT cleanup vs. Whisper)

**PM Skills Demonstrated:**
- Technical problem-solving and creative pivoting when blocked
- Cost optimization through architectural changes
- Managing third-party API constraints and limitations
- Risk mitigation (documented proxy blocking across multiple protocols)
- Data-driven decision making (cost/benefit analysis of alternatives)

# System Architecture

## Frontend Architecture
- **Interface**: Single-page application with a modern, glassmorphic UI, animated SVG brain icon, and a purple gradient theme. Includes a live visual cost tracker with a golden theme.
- **Theme System**: Light/Dark mode toggle with persistence via localStorage.
- **Upload Flow**: Supports drag-and-drop PDF uploads, Google Drive integration, and YouTube MP3 transcription (upload audio files extracted from YouTube). Provides progress tracking, real-time status updates, and persistent error notifications. Mobile-optimized upload boxes and progress bars.
- **Tag Library**: Cloud-based visual tag library section showing all uploaded documents with their extracted MBTI/Jungian tags. Features interactive tag cloud with frequency counts and document browsing by tags. Tags are loaded from Pinecone via `/api/tagged-documents` API, ensuring cross-device sync. Includes document rename feature with edit icon (✏️) next to each document name. **Smart Tag Interactions**: Single-click a tag to filter the document list (shows only docs with that tag, with visual feedback via green highlight and filter banner); double-click a tag to auto-fill chat with a pre-written question about that tag. Clicking the same tag again or the clear button removes the filter.
- **Chat Flow**: Integrates a chat interface with iPhone-style bubbles, allowing users to ask questions about uploaded documents and manage them via chat commands (`list docs`, `delete doc [id]`, `delete all`, `show doc [id]`, `help`). Answers are generated by GPT models, searching across all uploaded documents.
- **Features**: Auto-clipboard copy for document IDs, responsive design for mobile, and various UI enhancements for user interaction. Upload completion sound notification.

## Backend Architecture
- **Framework**: FastAPI with asynchronous operations and modern lifespan event handlers.
- **Runtime**: Python with Uvicorn ASGI server.
- **Design Pattern**: Stateless API where the frontend manages `document_id` and the backend uses it for Pinecone queries.
- **Deployment**: VM deployment to ensure inclusion of system packages like `ffmpeg`. Includes production-ready features:
  - Health check endpoint at `/health` for deployment monitoring
  - Robust database initialization with 3-retry logic and graceful degradation
  - Detailed startup logging for debugging deployment issues
  - Proper binding to 0.0.0.0:5000 for all network interfaces
  - Lifespan context manager for clean startup/shutdown handling

## Document Processing Pipeline
- **PDF Parsing**: Uses PyPDF2 for text extraction from text-based PDFs. Supports encrypted PDFs via PyCryptodome.
- **Text Chunking**: Employs LangChain's `RecursiveCharacterTextSplitter` to break documents into overlapping chunks (1000 characters with 200 character overlap).
- **InnerVerse Intelligence Layer**: Automatic MBTI/Jungian taxonomy tagging system using GPT-3.5. Analyzes uploaded documents and extracts relevant tags across 6 layers: Cognitive Architecture, Typological Structures, Type-Specific Indexing, Depth Psychology & Jungian Theory, Behavioral & Expression Layers, and Integration & Meta Layers. Tags are stored in Pinecone metadata for advanced filtering and retrieval.
- **YouTube MP3 Transcription**: Users download MP3, M4A, or WAV files from YouTube videos using browser extensions (Video DownloadHelper, 4K Video Downloader), then upload them to InnerVerse. Accepts audio files up to 24MB (Whisper API limit). Transcribes using OpenAI Whisper API (~$0.006/min), generates formatted PDFs using ReportLab, auto-tags with MBTI/Jungian taxonomy, and indexes in Pinecone. This workflow bypasses YouTube's datacenter IP blocking that prevents direct URL transcription from Replit's servers.
- **Text to PDF**: Converts text to formatted PDFs with automatic punctuation and grammar fixes using GPT-3.5.
- **Large File Support**: Efficient binary uploads (multipart/form-data), batch processing for Pinecone upserts (batches of 50), and increased embedding timeouts for large files.

## Vector Storage Strategy
- **Database**: Pinecone vector database (index: "mbti-knowledge") for storing document embeddings.
- **Query Strategy**: Filters by `document_id` for document-specific queries, and performs global searches across all documents when no specific ID is provided.

## Embedding Generation
- **Provider**: OpenAI API (`text-embedding-ada-002` model) for generating embeddings.
- **Performance**: Embeddings are batch processed before upserting to Pinecone.

## API Structure
- **Upload**: `POST /upload` (multipart/form-data) and `POST /upload-base64` (JSON) for PDF uploads.
- **YouTube MP3 Upload**: `POST /upload-audio` (multipart/form-data) for audio file uploads (MP3, M4A, WAV, MP4). Transcribes with Whisper API, generates PDF, auto-tags, and indexes in Pinecone.
- **Query**: `POST /query` for document Q&A.
- **Text to PDF**: `POST /text-to-pdf`.
- **Document Report**: `GET /documents/report` (CSV export with Hawaii timezone timestamps).
- **Document Management**: `DELETE /documents/{document_id}` for removing single document; `DELETE /documents/all` for removing all documents; `PATCH /documents/{document_id}/rename` for renaming documents (updates metadata in all Pinecone vectors); chat commands for `list docs`, `delete doc [id]`, `delete all`, `show doc [id]`, `help`.
- **Usage Monitoring**: `/api/usage` for detailed spending statistics.
- **Static Files**: Serves frontend assets and documentation (`/docs` for Swagger UI).
- **CORS**: Enabled for all origins.

## Configuration Management
- **Environment Variables**: API keys (OPENAI_API_KEY, PINECONE_API_KEY, PINECONE_INDEX) are managed via Replit Secrets.
- **YouTube Cookies**: Stored in `youtube_cookies.txt` file for easier updates and to bypass size limits.
- **Client Initialization**: Lazy initialization pattern is used for API clients.

## API Usage and Cost Tracking
- **Tracking**: Logs every OpenAI API call (embeddings, chat, Whisper) with token counts and costs.
- **Persistence**: Cost data is saved to a PostgreSQL database, ensuring persistence across restarts.
- **Monitoring**: `/api/usage` endpoint provides detailed spending statistics in Hawaii time.
- **Rate Limiting**: Maximum 100 requests per hour to prevent cost spikes.
- **Visual Tracker**: Real-time visual display of total cost, last 24 hours, and breakdown by operation type.

# External Dependencies

## Vector Database
- **Pinecone**: Cloud-based vector database for storing and querying embeddings.

## AI/ML Services
- **OpenAI API**: Used for text embeddings (text-embedding-ada-002), GPT-3.5-turbo for Q&A and text fixes, and Whisper API for audio transcription.

## Document Processing
- **PyPDF2**: For PDF parsing and text extraction.
- **LangChain**: For text splitting utilities.
- **yt-dlp**: For downloading audio from YouTube videos.
- **ReportLab**: For generating formatted PDFs.
- **PostgreSQL**: For persistent cost tracking.

## Web Framework
- **FastAPI**: Python web framework.
- **Uvicorn**: ASGI server.
- **Pydantic**: Data validation.

## Integrations
- **Google Drive Picker API**: For seamless integration with Google Drive.
- **ffmpeg**: System dependency for audio processing with `yt-dlp`.
- **poppler**: System dependency for PDF rendering (used by pdf2image for OCR).
- **tesseract**: System dependency for optical character recognition.