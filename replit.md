# Overview

InnerVerse is a FastAPI-based PDF Q&A application designed for intelligent knowledge retrieval from uploaded documents. It enables users to upload PDFs via a modern web interface, transcribe audio and YouTube videos into searchable PDFs, and generate document reports. The core functionality involves chunking, embedding, and storing document content in Pinecone, then leveraging OpenAI's GPT models for answering user queries. The application also provides robust API usage monitoring with real-time cost tracking and rate limiting, offering an intuitive and efficient experience for document interaction.

# User Preferences

Preferred communication style: Simple, everyday language.

# System Architecture

## Frontend Architecture
- **Interface**: Single-page application with a glassmorphic UI, animated SVG brain icon, purple gradient theme, and a live visual cost tracker.
- **Theme System**: Light/Dark mode toggle with persistence.
- **Upload Flow**: Supports drag-and-drop PDF uploads, Google Drive integration, and YouTube MP3 transcription with progress tracking and persistent error notifications. Mobile-optimized.
- **Tag Library**: Cloud-based visual tag library with interactive tag clouds, frequency counts, document browsing by tags, and a document rename feature. Supports filtering by single-clicking tags and auto-filling chat with questions by double-clicking.
- **Chat Flow**: iPhone-style chat interface for document Q&A and management via commands (e.g., `list docs`, `delete doc [id]`). Answers are generated by GPT models across all uploaded documents.
- **Claude Master Interface** (`/claude`): Advanced conversational workspace powered by Claude Sonnet 4 with a production-ready Claude.ai-style interface. Features 7 organized project categories, persistent conversations stored in PostgreSQL, and a collapsible sidebar. Responsive design (PUSH mode for desktop, OVERLAY mode for mobile). Includes a welcome screen with suggested prompts and robust state management. Security features include HTML escaping to prevent XSS. Integrates automatic InnerVerse backend queries and web search capabilities via Claude API function calling. Supports PWA for mobile installation.

## Backend Architecture
- **Framework**: FastAPI with asynchronous operations.
- **Runtime**: Python with Uvicorn ASGI server.
- **Design Pattern**: Stateless API where `document_id` is managed by the frontend.
- **Deployment**: VM deployment with health checks, robust database initialization, and detailed logging.
- **API Usage and Cost Tracking**: Logs and persists OpenAI API call costs to PostgreSQL, accessible via `/api/usage`, with a rate limit of 100 requests per hour.

## Document Processing Pipeline
- **PDF Parsing**: Uses PyPDF2 for text extraction, supporting encrypted PDFs.
- **Text Chunking**: LangChain's `RecursiveCharacterTextSplitter` for overlapping text chunks.
- **InnerVerse Intelligence Layer**: Automatic MBTI/Jungian taxonomy tagging using GPT-3.5, storing tags in Pinecone metadata.
- **YouTube MP3 Transcription**: Processes uploaded audio (MP3, M4A, WAV, MP4) up to 24MB via OpenAI Whisper API, generates formatted PDFs using ReportLab, auto-tags, and indexes in Pinecone.
- **Text to PDF**: Converts text to formatted PDFs with GPT-3.5 for punctuation and grammar fixes.
- **Reprocess PDF**: Enhances existing Whisper-transcribed PDFs by extracting text, cleaning with GPT-3.5, and returning an improved PDF.
- **Large File Support**: Efficient binary uploads and batch processing for Pinecone upserts.

## Vector Storage Strategy
- **Database**: Pinecone vector database ("mbti-knowledge" index).
- **Query Strategy**: Filters by `document_id` for specific documents or performs global searches.

## Embedding Generation
- **Provider**: OpenAI API (`text-embedding-ada-002`) for batch-processed embeddings.

## API Structure
- **Upload**: `POST /upload`, `POST /upload-base64` (PDFs), `POST /upload-audio` (audio).
- **Query**: `POST /query`.
- **Text/PDF Processing**: `POST /text-to-pdf`, `POST /reprocess-pdf`.
- **Document Management**: `GET /documents/report`, `DELETE /documents/{document_id}`, `DELETE /documents/all`, `PATCH /documents/{document_id}/rename`, chat commands.
- **Claude Chat API**: Endpoints for managing project categories, conversations, messages, and searching.
- **Usage Monitoring**: `/api/usage`.
- **Static Files**: Serves frontend assets and Swagger UI documentation.
- **PWA Support**: Service worker, manifest, and icons for mobile installation.
- **CORS**: Enabled for all origins.

## Configuration Management
- **Environment Variables**: API keys managed via Replit Secrets.
- **Client Initialization**: Lazy initialization for API clients.

# External Dependencies

## Vector Database
- **Pinecone**: Vector database.

## AI/ML Services
- **OpenAI API**: For text embeddings (`text-embedding-ada-002`), GPT-3.5-turbo (Q&A, text fixes), and Whisper API (audio transcription).
- **Anthropic API**: Claude Sonnet 4 for the Claude Master Interface.

## Document Processing
- **PyPDF2**: PDF parsing.
- **LangChain**: Text splitting.
- **ReportLab**: PDF generation.
- **ffmpeg**: System dependency for audio processing.
- **poppler**: System dependency for PDF rendering.
- **tesseract**: System dependency for OCR.

## Data Storage
- **PostgreSQL**: For persistent cost tracking and Claude conversation history.

## Web Framework
- **FastAPI**: Python web framework.
- **Uvicorn**: ASGI server.
- **Pydantic**: Data validation.

## Integrations
- **Google Drive Picker API**: Google Drive integration.
- **yt-dlp**: YouTube video downloading.