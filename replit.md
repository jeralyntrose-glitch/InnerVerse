# Overview

InnerVerse is a FastAPI-based PDF Q&A application that provides intelligent answers from uploaded PDF documents. It features a modern web interface with drag-and-drop upload capabilities, processes documents by chunking and embedding their content, stores these embeddings in Pinecone, and leverages OpenAI's GPT models for answering user queries based on the document content. The application aims to offer an intuitive user experience for document interaction and knowledge retrieval, including the ability to transcribe YouTube videos into searchable PDFs and generate document reports. The project also includes robust API usage monitoring with real-time cost tracking and rate limiting.

# User Preferences

Preferred communication style: Simple, everyday language.

# System Architecture

## Frontend Architecture
- **Interface**: Single-page application with a modern, glassmorphic UI, animated SVG brain icon, and a purple gradient theme. Includes a live visual cost tracker with a golden theme.
- **Theme System**: Light/Dark mode toggle with persistence via localStorage.
- **Upload Flow**: Supports drag-and-drop PDF uploads, Google Drive integration, and YouTube video transcription to PDF. Provides progress tracking, real-time status updates, and persistent error notifications. Mobile-optimized upload boxes and progress bars.
- **Tag Library**: Cloud-based visual tag library section showing all uploaded documents with their extracted MBTI/Jungian tags. Features interactive tag cloud with frequency counts and document browsing by tags. Tags are loaded from Pinecone via `/api/tagged-documents` API, ensuring cross-device sync. Includes document rename feature with edit icon (✏️) next to each document name. **Smart Tag Interactions**: Single-click a tag to filter the document list (shows only docs with that tag, with visual feedback via green highlight and filter banner); double-click a tag to auto-fill chat with a pre-written question about that tag. Clicking the same tag again or the clear button removes the filter.
- **Chat Flow**: Integrates a chat interface with iPhone-style bubbles, allowing users to ask questions about uploaded documents and manage them via chat commands (`list docs`, `delete doc [id]`, `delete all`, `show doc [id]`, `help`). Answers are generated by GPT models, searching across all uploaded documents.
- **Features**: Auto-clipboard copy for document IDs, responsive design for mobile, and various UI enhancements for user interaction. Upload completion sound notification.

## Backend Architecture
- **Framework**: FastAPI with asynchronous operations and modern lifespan event handlers.
- **Runtime**: Python with Uvicorn ASGI server.
- **Design Pattern**: Stateless API where the frontend manages `document_id` and the backend uses it for Pinecone queries.
- **Deployment**: VM deployment to ensure inclusion of system packages like `ffmpeg`. Includes production-ready features:
  - Health check endpoint at `/health` for deployment monitoring
  - Robust database initialization with 3-retry logic and graceful degradation
  - Detailed startup logging for debugging deployment issues
  - Proper binding to 0.0.0.0:5000 for all network interfaces
  - Lifespan context manager for clean startup/shutdown handling

## Document Processing Pipeline
- **PDF Parsing**: Uses PyPDF2 for text extraction from text-based PDFs. Supports encrypted PDFs via PyCryptodome.
- **Text Chunking**: Employs LangChain's `RecursiveCharacterTextSplitter` to break documents into overlapping chunks (1000 characters with 200 character overlap).
- **InnerVerse Intelligence Layer**: Automatic MBTI/Jungian taxonomy tagging system using GPT-3.5. Analyzes uploaded documents and extracts relevant tags across 6 layers: Cognitive Architecture, Typological Structures, Type-Specific Indexing, Depth Psychology & Jungian Theory, Behavioral & Expression Layers, and Integration & Meta Layers. Tags are stored in Pinecone metadata for advanced filtering and retrieval.
- **YouTube Transcription**: Utilizes `yt-dlp` (v2025.10.14) for audio extraction and OpenAI Whisper API for transcription (~$0.006/min). Includes User-Agent and referer headers to mimic browser requests. Includes extended timeouts for long videos (60 min frontend, 15 min Whisper) and robust error handling. Generates formatted PDFs using ReportLab. **Known Issue**: YouTube aggressively blocks datacenter IPs (like Replit's servers). Cookies exported from home browsers don't work on datacenter IPs because YouTube ties authentication to IP addresses. This may cause HTTP 403 errors even with fresh cookies. Workarounds attempted: User-Agent headers, referer headers, cookie authentication. Full solution would require residential proxies or running locally.
- **Text to PDF**: Converts text to formatted PDFs with automatic punctuation and grammar fixes using GPT-3.5.
- **Large File Support**: Efficient binary uploads (multipart/form-data), batch processing for Pinecone upserts (batches of 50), and increased embedding timeouts for large files.

## Vector Storage Strategy
- **Database**: Pinecone vector database (index: "mbti-knowledge") for storing document embeddings.
- **Query Strategy**: Filters by `document_id` for document-specific queries, and performs global searches across all documents when no specific ID is provided.

## Embedding Generation
- **Provider**: OpenAI API (`text-embedding-ada-002` model) for generating embeddings.
- **Performance**: Embeddings are batch processed before upserting to Pinecone.

## API Structure
- **Upload**: `POST /upload` (multipart/form-data) and `POST /upload-base64` (JSON) for PDF uploads.
- **Query**: `POST /query` for document Q&A.
- **YouTube Transcription**: `POST /transcribe-youtube` (Whisper API, ~$0.006/min).
- **Text to PDF**: `POST /text-to-pdf`.
- **Document Report**: `GET /documents/report` (CSV export with Hawaii timezone timestamps).
- **Document Management**: `DELETE /documents/{document_id}` for removing single document; `DELETE /documents/all` for removing all documents; `PATCH /documents/{document_id}/rename` for renaming documents (updates metadata in all Pinecone vectors); chat commands for `list docs`, `delete doc [id]`, `delete all`, `show doc [id]`, `help`.
- **Usage Monitoring**: `/api/usage` for detailed spending statistics.
- **Static Files**: Serves frontend assets and documentation (`/docs` for Swagger UI).
- **CORS**: Enabled for all origins.

## Configuration Management
- **Environment Variables**: API keys (OPENAI_API_KEY, PINECONE_API_KEY, PINECONE_INDEX) are managed via Replit Secrets.
- **YouTube Cookies**: Stored in `youtube_cookies.txt` file for easier updates and to bypass size limits.
- **Client Initialization**: Lazy initialization pattern is used for API clients.

## API Usage and Cost Tracking
- **Tracking**: Logs every OpenAI API call (embeddings, chat, Whisper) with token counts and costs.
- **Persistence**: Cost data is saved to a PostgreSQL database, ensuring persistence across restarts.
- **Monitoring**: `/api/usage` endpoint provides detailed spending statistics in Hawaii time.
- **Rate Limiting**: Maximum 100 requests per hour to prevent cost spikes.
- **Visual Tracker**: Real-time visual display of total cost, last 24 hours, and breakdown by operation type.

# External Dependencies

## Vector Database
- **Pinecone**: Cloud-based vector database for storing and querying embeddings.

## AI/ML Services
- **OpenAI API**: Used for text embeddings (text-embedding-ada-002), GPT-3.5-turbo for Q&A and text fixes, and Whisper API for audio transcription.

## Document Processing
- **PyPDF2**: For PDF parsing and text extraction.
- **LangChain**: For text splitting utilities.
- **yt-dlp**: For downloading audio from YouTube videos.
- **ReportLab**: For generating formatted PDFs.
- **PostgreSQL**: For persistent cost tracking.

## Web Framework
- **FastAPI**: Python web framework.
- **Uvicorn**: ASGI server.
- **Pydantic**: Data validation.

## Integrations
- **Google Drive Picker API**: For seamless integration with Google Drive.
- **ffmpeg**: System dependency for audio processing with `yt-dlp`.
- **poppler**: System dependency for PDF rendering (used by pdf2image for OCR).
- **tesseract**: System dependency for optical character recognition.