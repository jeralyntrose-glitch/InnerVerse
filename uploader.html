<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes"/>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="format-detection" content="telephone=no" />
  <title>Axis Mind - Upload & Chat</title>
  <link rel="stylesheet" href="/static/style.css?v=47-SCROLL-FIX" />
</head>
<body>
  <!-- Top Navigation -->
  <nav class="top-nav">
    <a href="/content-atlas" class="nav-btn nav-btn-text" aria-label="Content Atlas" title="Content Atlas">
      Content Atlas
    </a>
    <button id="theme-toggle" class="theme-toggle nav-btn" aria-label="Toggle theme">
      <svg class="sun-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="5"></circle>
        <line x1="12" y1="1" x2="12" y2="3"></line>
        <line x1="12" y1="21" x2="12" y2="23"></line>
        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
        <line x1="1" y1="12" x2="3" y2="12"></line>
        <line x1="21" y1="12" x2="23" y2="12"></line>
        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
      </svg>
      <svg class="moon-icon hidden" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
      </svg>
    </button>
  </nav>

  <div class="page-wrapper">
    <div class="branding">
      <!-- Neural Network Brain Icon -->
      <svg class="brain-icon" width="130" height="130" viewBox="0 0 200 200">
        <defs>
          <linearGradient id="brainGradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:#8b5cf6;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#06b6d4;stop-opacity:1" />
          </linearGradient>
        </defs>
        
        <!-- Neural network nodes and connections -->
        <g class="brain-network">
          <!-- Connections -->
          <line x1="60" y1="50" x2="100" y2="80" stroke="url(#brainGradient)" stroke-width="2" opacity="0.6"/>
          <line x1="140" y1="50" x2="100" y2="80" stroke="url(#brainGradient)" stroke-width="2" opacity="0.6"/>
          <line x1="60" y1="50" x2="100" y2="120" stroke="url(#brainGradient)" stroke-width="2" opacity="0.6"/>
          <line x1="140" y1="50" x2="100" y2="120" stroke="url(#brainGradient)" stroke-width="2" opacity="0.6"/>
          <line x1="40" y1="100" x2="100" y2="80" stroke="url(#brainGradient)" stroke-width="2" opacity="0.6"/>
          <line x1="160" y1="100" x2="100" y2="80" stroke="url(#brainGradient)" stroke-width="2" opacity="0.6"/>
          <line x1="40" y1="100" x2="100" y2="120" stroke="url(#brainGradient)" stroke-width="2" opacity="0.6"/>
          <line x1="160" y1="100" x2="100" y2="120" stroke="url(#brainGradient)" stroke-width="2" opacity="0.6"/>
          <line x1="60" y1="150" x2="100" y2="120" stroke="url(#brainGradient)" stroke-width="2" opacity="0.6"/>
          <line x1="140" y1="150" x2="100" y2="120" stroke="url(#brainGradient)" stroke-width="2" opacity="0.6"/>
          
          <!-- Nodes -->
          <circle cx="60" cy="50" r="8" fill="url(#brainGradient)" opacity="0.9"/>
          <circle cx="140" cy="50" r="8" fill="url(#brainGradient)" opacity="0.9"/>
          <circle cx="40" cy="100" r="8" fill="url(#brainGradient)" opacity="0.9"/>
          <circle cx="100" cy="80" r="10" fill="url(#brainGradient)"/>
          <circle cx="100" cy="120" r="10" fill="url(#brainGradient)"/>
          <circle cx="160" cy="100" r="8" fill="url(#brainGradient)" opacity="0.9"/>
          <circle cx="60" cy="150" r="8" fill="url(#brainGradient)" opacity="0.9"/>
          <circle cx="140" cy="150" r="8" fill="url(#brainGradient)" opacity="0.9"/>
        </g>
      </svg>

      <h1 class="brand-title">AXIS MIND</h1>
      <p class="tagline">Where cognition becomes code.</p>
    </div>

    <div id="drop-area" class="drop-area">
      <p class="drop-text">Drag & drop your PDF here</p>
      <span class="or-text">or</span>
      <div class="upload-buttons">
        <label for="fileElem" class="btn-primary">Start uploading</label>
        <button id="gdrive-btn" class="btn-secondary">üìÅ Google Drive</button>
      </div>
      <input type="file" id="fileElem" accept="application/pdf" multiple />
    </div>

    <!-- üìä Upload Status Section -->
    <div id="upload-status-section" class="upload-status-section hidden">
      <div class="status-summary">
        <div class="summary-item">
          <span class="summary-label">Uploaded</span>
          <span id="count-uploaded" class="summary-count">0</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Completed</span>
          <span id="count-completed" class="summary-count">0</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Errors</span>
          <span id="count-errors" class="summary-count">0</span>
        </div>
        <button id="cancel-upload-btn" class="cancel-upload-btn hidden">‚úï Cancel</button>
      </div>
      <div id="upload-list" class="upload-list"></div>
    </div>

    <div id="status" class="status"></div>

    <!-- üé¨ YouTube Transcription Section (Collapsible) -->
    <div class="youtube-section">
      <button class="youtube-toggle" id="youtube-toggle">
        <div class="youtube-toggle-content">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle; margin-right: 8px;">
            <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
          </svg>
          <span>YouTube Transcription</span>
        </div>
        <svg class="youtube-chevron" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
        </svg>
      </button>
      <div class="youtube-content" id="youtube-content">
        <p class="youtube-description">Paste a YouTube URL to transcribe and download as PDF</p>
        <div class="youtube-input-group">
          <input type="text" id="youtube-url" placeholder="https://www.youtube.com/watch?v=..." />
          <button id="transcribe-btn" class="btn-transcribe">Transcribe</button>
        </div>
        <div id="youtube-status" class="youtube-status hidden"></div>
      </div>
    </div>

    <!-- üì∫ YouTube Video Import Section (Collapsible) -->
    <div class="youtube-import-section">
      <button class="youtube-import-toggle" id="youtube-import-toggle">
        <div class="youtube-import-toggle-content">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
            <path d="M3 15v4c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2v-4M17 8l-5-5-5 5M12 3v12"></path>
          </svg>
          <span>üì∫ YouTube Library Import</span>
        </div>
        <svg class="youtube-import-chevron" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
        </svg>
      </button>
      <div class="youtube-import-content" id="youtube-import-content">
        <p class="youtube-import-description">Upload CSV file with YouTube videos to match to lessons</p>
        
        <!-- CSV Upload -->
        <div class="csv-upload-section">
          <label for="csv-file-input" class="btn-csv-upload">üìÑ Select CSV File</label>
          <input type="file" id="csv-file-input" accept=".csv" style="display: none;" />
          <div id="csv-file-name" class="csv-file-name hidden"></div>
          <button id="import-csv-btn" class="btn-import-csv hidden">üöÄ Import & Match Videos</button>
        </div>
        
        <!-- Import Progress -->
        <div id="csv-import-progress" class="csv-import-progress hidden">
          <div class="import-status-text">Processing CSV...</div>
          <div class="import-progress-bar-container">
            <div class="import-progress-bar"></div>
          </div>
        </div>
        
        <!-- Match Results Summary -->
        <div id="match-results-summary" class="match-results-summary hidden">
          <h3>üìä Match Results</h3>
          <div class="match-stats-grid">
            <div class="match-stat high-confidence">
              <div class="stat-label">High Confidence</div>
              <div id="stat-high" class="stat-value">0</div>
              <div class="stat-desc">Auto-linked to lessons</div>
            </div>
            <div class="match-stat medium-confidence">
              <div class="stat-label">Medium Confidence</div>
              <div id="stat-medium" class="stat-value">0</div>
              <div class="stat-desc">Needs review</div>
            </div>
            <div class="match-stat low-confidence">
              <div class="stat-label">Low Confidence</div>
              <div id="stat-low" class="stat-value">0</div>
              <div class="stat-desc">Needs review</div>
            </div>
            <div class="match-stat unmatched">
              <div class="stat-label">Unmatched</div>
              <div id="stat-unmatched" class="stat-value">0</div>
              <div class="stat-desc">No lesson found</div>
            </div>
          </div>
          
          <!-- View Pending Videos Button -->
          <button id="view-pending-btn" class="btn-view-pending">
            üëÅÔ∏è Review Pending Videos
          </button>
        </div>
        
        <!-- Pending Videos Review -->
        <div id="pending-videos-section" class="pending-videos-section hidden">
          <h3>üìã Pending Videos for Review</h3>
          <div class="pending-filters">
            <button class="filter-btn active" data-filter="all">All</button>
            <button class="filter-btn" data-filter="pending_review">Medium/Low</button>
            <button class="filter-btn" data-filter="unmatched">Unmatched</button>
          </div>
          <div id="pending-videos-list" class="pending-videos-list">
            <div class="pending-placeholder">Loading pending videos...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- üìù Text to PDF Section (Collapsible) -->
    <div class="text-to-pdf-section">
      <button class="text-pdf-toggle" id="text-pdf-toggle">
        <div class="text-pdf-toggle-content">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
            <polyline points="10 9 9 9 8 9"></polyline>
          </svg>
          <span>Text to PDF</span>
        </div>
        <svg class="text-pdf-chevron" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
        </svg>
      </button>
      <div class="text-pdf-content" id="text-pdf-content">
        <p class="text-pdf-description">Paste text to create a formatted PDF with automatic punctuation fixes</p>
        <div class="text-pdf-form">
          <input type="text" id="pdf-title" placeholder="Document Title" class="pdf-title-input" />
          <textarea id="pdf-text" placeholder="Paste your text here... (AI will fix punctuation and grammar automatically)" rows="8"></textarea>
          <button id="create-pdf-btn" class="btn-create-pdf">‚ú® Create PDF</button>
        </div>
        <div id="text-pdf-progress" class="text-pdf-progress hidden">
          <div class="text-pdf-status-text"></div>
          <div class="text-pdf-progress-bar-container">
            <div class="text-pdf-progress-bar"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- üìö Document Library Section -->
    <div class="tag-library-section">
      <button class="tag-library-toggle" id="tag-library-toggle">
        <div class="tag-library-toggle-content">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
          </svg>
          <span>üìö Document Library</span>
        </div>
        <svg class="tag-library-chevron" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
        </svg>
      </button>
      
      <div class="tag-library-content" id="tag-library-content">
        <p class="tag-library-description">Browse and manage your uploaded documents</p>
        
        <!-- Document List -->
        <div class="documents-section">
          <div id="tagged-documents-list" class="documents-list">
            <div class="documents-placeholder">No documents yet. Upload a PDF to get started!</div>
          </div>
        </div>
      </div>
    </div>

    <!-- üöÄ ULTIMATE OPTIMIZATION Section -->
    <div class="ultimate-optimize-section">
      <button class="ultimate-optimize-toggle" id="ultimate-optimize-toggle">
        <div class="ultimate-optimize-toggle-content">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
            <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
          </svg>
          <span>üöÄ ULTIMATE OPTIMIZATION - Transform ALL Files</span>
        </div>
        <svg class="ultimate-optimize-chevron" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
        </svg>
      </button>
      
      <div class="ultimate-optimize-content" id="ultimate-optimize-content">
        <div class="ultimate-optimize-info">
          <h3>üî• The Best-in-Class RAG Backend</h3>
          <p class="ultimate-optimize-description">
            Full 3-stage pipeline + semantic chunking for ALL your Season 1-21 documents:
          </p>
          
          <div class="optimization-features">
            <div class="feature-item">
              <span class="feature-icon">üîß</span>
              <div class="feature-text">
                <strong>Stage 1:</strong> Fix ALL typos (MBTI types, functions, UDSF/SDUF)
              </div>
            </div>
            <div class="feature-item">
              <span class="feature-icon">ü§ñ</span>
              <div class="feature-text">
                <strong>Stage 2:</strong> GPT-4o-mini cleaning (60-70% size reduction, no quality loss)
              </div>
            </div>
            <div class="feature-item">
              <span class="feature-icon">üß†</span>
              <div class="feature-text">
                <strong>Semantic Chunking:</strong> Respect concept boundaries for perfect RAG
              </div>
            </div>
            <div class="feature-item">
              <span class="feature-icon">üîÑ</span>
              <div class="feature-text">
                <strong>Re-embedding:</strong> text-embedding-3-large with optimized chunks
              </div>
            </div>
          </div>
          
          <div class="optimization-stats">
            <div class="stat-box">
              <div class="stat-label">Estimated Time</div>
              <div class="stat-value">3-4 hours</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">Estimated Cost</div>
              <div class="stat-value">~$6-9</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">Quality Boost</div>
              <div class="stat-value">MAXIMUM üî•</div>
            </div>
          </div>
          
          <div class="warning-box">
            ‚ö†Ô∏è <strong>Important:</strong> This will replace ALL existing vectors with optimized ones. 
            Make sure you have backups if needed. This process takes 3-4 hours and cannot be cancelled mid-way.
          </div>
          
          <button id="ultimate-optimize-btn" class="btn-ultimate-optimize">
            üöÄ START ULTIMATE OPTIMIZATION
          </button>
        </div>
        
        <div id="ultimate-optimize-progress" class="ultimate-optimize-progress hidden">
          <div class="progress-header">
            <h3>üî• Ultimate Optimization in Progress...</h3>
            <p class="progress-subtitle">This will take 3-4 hours. You can close this page.</p>
          </div>
          
          <div class="progress-stats-grid">
            <div class="progress-stat">
              <div class="progress-stat-label">Documents Processed</div>
              <div class="progress-stat-value" id="ultimate-docs-processed">0 / 0</div>
            </div>
            <div class="progress-stat">
              <div class="progress-stat-label">Vectors Optimized</div>
              <div class="progress-stat-value" id="ultimate-vectors-optimized">0</div>
            </div>
            <div class="progress-stat">
              <div class="progress-stat-label">Failed</div>
              <div class="progress-stat-value error" id="ultimate-docs-failed">0</div>
            </div>
          </div>
          
          <div class="progress-bar-container">
            <div class="progress-bar-fill" id="ultimate-progress-bar"></div>
            <div class="progress-bar-text" id="ultimate-progress-text">0%</div>
          </div>
          
          <div class="current-document-box">
            <div class="current-doc-label">Current Document:</div>
            <div class="current-doc-name" id="ultimate-current-doc">Initializing...</div>
          </div>
          
          <div id="ultimate-optimize-result" class="ultimate-optimize-result"></div>
        </div>
      </div>
    </div>

    <!-- üîÑ Batch Re-Tagging Section -->
    <div class="batch-retag-section">
      <button class="batch-retag-toggle" id="batch-retag-toggle">
        <div class="batch-retag-toggle-content">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
            <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
          </svg>
          <span>üöÄ Batch Re-Tag All Documents</span>
        </div>
        <svg class="batch-retag-chevron" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
        </svg>
      </button>
      
      <div class="batch-retag-content" id="batch-retag-content">
        <p class="batch-retag-description">
          Upgrade all existing documents in Pinecone with the new structured metadata system (GPT-4o-mini).
          This adds 10 structured fields to every document: content_type, difficulty, primary_category, types_discussed, 
          functions_covered, relationship_type, quadra, temple, topics, and use_case.
        </p>
        
        <div class="batch-retag-warning">
          ‚ö†Ô∏è <strong>Safe Operation:</strong> This only updates metadata - your embeddings and original text remain unchanged.
        </div>
        
        <button id="batch-retag-btn" class="btn-batch-retag">
          üîÑ Start Batch Re-Tagging
        </button>
        
        <div id="batch-retag-progress" class="batch-retag-progress hidden">
          <div class="batch-retag-status-text">Processing documents...</div>
          <div class="batch-retag-stats">
            <div class="batch-stat">
              <span class="batch-stat-label">Total Documents:</span>
              <span id="batch-total" class="batch-stat-value">0</span>
            </div>
            <div class="batch-stat">
              <span class="batch-stat-label">Processed:</span>
              <span id="batch-processed" class="batch-stat-value">0</span>
            </div>
            <div class="batch-stat">
              <span class="batch-stat-label">Vectors Updated:</span>
              <span id="batch-vectors" class="batch-stat-value">0</span>
            </div>
          </div>
          <div id="batch-retag-result" class="batch-retag-result"></div>
        </div>
      </div>
    </div>

    <!-- üéì Training Pair Generator Section -->
    <div class="training-pairs-section">
      <button class="training-pairs-toggle" id="training-pairs-toggle">
        <div class="training-pairs-toggle-content">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
          </svg>
          <span>üéì Training Pair Generator</span>
        </div>
        <svg class="training-pairs-chevron" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
        </svg>
      </button>
      
      <div class="training-pairs-content" id="training-pairs-content">
        <!-- Stats Overview -->
        <div class="training-stats-overview" id="training-stats-overview">
          <div class="training-stat-item">
            <div class="training-stat-value" id="training-stat-pending">0</div>
            <div class="training-stat-label">Pending Review</div>
          </div>
          <div class="training-stat-item">
            <div class="training-stat-value" id="training-stat-approved">0</div>
            <div class="training-stat-label">Approved</div>
          </div>
          <div class="training-stat-item">
            <div class="training-stat-value" id="training-stat-pairs">0</div>
            <div class="training-stat-label">Total Pairs</div>
          </div>
        </div>
        
        <!-- Resume Section (shows if interrupted files exist) -->
        <div class="training-resume-section hidden" id="training-resume-section">
          <div class="training-resume-header">
            <span>‚ö†Ô∏è Interrupted Processing</span>
          </div>
          <div class="training-resume-list" id="training-resume-list">
            <!-- Populated by JS -->
          </div>
        </div>
        
        <!-- Upload Section -->
        <div class="training-upload-section">
          <p class="training-description">
            Upload a PDF to generate Q&A training pairs for fine-tuning. Works with transcripts and books of any length.
          </p>
          <div class="training-upload-row">
            <label for="training-file-input" class="btn-training-upload">
              üìÑ Choose PDF
            </label>
            <input type="file" id="training-file-input" accept="application/pdf" style="display: none;" />
            <span class="training-file-name" id="training-file-name">No file selected</span>
            <button id="training-process-btn" class="btn-training-process" disabled>
              ü§ñ Generate Pairs
            </button>
          </div>
        </div>
        
        <!-- Processing Progress -->
        <div class="training-progress-section hidden" id="training-progress-section">
          <div class="training-progress-header">
            <h4>üîÑ Processing: <span id="training-progress-filename">file.pdf</span></h4>
          </div>
          <div class="training-progress-stats">
            <div class="training-progress-stat">
              <span class="training-progress-label">Chunks:</span>
              <span class="training-progress-value" id="training-progress-chunks">0 / 0</span>
            </div>
            <div class="training-progress-stat">
              <span class="training-progress-label">Pairs Generated:</span>
              <span class="training-progress-value" id="training-progress-pairs">0</span>
            </div>
          </div>
          <div class="training-progress-bar-container">
            <div class="training-progress-bar" id="training-progress-bar"></div>
          </div>
          <div class="training-progress-status" id="training-progress-status">
            Initializing...
          </div>
        </div>
        
        <!-- Pending Files List -->
        <div class="training-files-section">
          <div class="training-files-header">
            <h4>üìã Pending Review</h4>
            <button class="btn-refresh-training" id="btn-refresh-training" title="Refresh">üîÑ</button>
          </div>
          <div class="training-files-list" id="training-pending-list">
            <div class="training-files-placeholder">No files pending review</div>
          </div>
        </div>
        
        <!-- Approved Files List -->
        <div class="training-files-section">
          <div class="training-files-header">
            <h4>‚úÖ Approved</h4>
          </div>
          <div class="training-files-list" id="training-approved-list">
            <div class="training-files-placeholder">No approved files yet</div>
          </div>
        </div>
        
        <!-- Download Section -->
        <div class="training-download-section">
          <button id="training-combine-btn" class="btn-training-combine">
            üì¶ Combine All & Download
          </button>
          <p class="training-download-note">
            Combines all approved files into training_data.jsonl with duplicates removed and shuffled.
          </p>
        </div>
      </div>
    </div>

    <!-- üí∞ Cost Tracker Section -->
    <div class="cost-tracker-section">
      <button class="cost-tracker-toggle" id="cost-tracker-toggle">
        <div class="cost-tracker-toggle-content">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
            <line x1="12" y1="1" x2="12" y2="23"></line>
            <polyline points="17 5 12 1 7 5"></polyline>
            <polyline points="7 19 12 23 17 19"></polyline>
          </svg>
          <span>API Cost Tracker</span>
        </div>
        <svg class="cost-tracker-chevron" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
        </svg>
      </button>
      
      <div class="cost-stats" id="cost-tracker-content">
        <div class="cost-stat-row">
          <div class="cost-stat-item">
            <div class="cost-stat-label">Total Cost</div>
            <div id="total-cost" class="cost-stat-value">$0.00</div>
          </div>
          <div class="cost-stat-item">
            <div class="cost-stat-label">Last 24 Hours</div>
            <div id="cost-24h" class="cost-stat-value">$0.00</div>
          </div>
        </div>
        
        <div class="cost-breakdown">
          <div class="cost-breakdown-label">By Operation</div>
          <div id="cost-by-operation" class="cost-breakdown-items">
            <div class="cost-breakdown-item">
              <span>Chat: <strong>$0.00</strong></span>
            </div>
            <div class="cost-breakdown-item">
              <span>Embeddings: <strong>$0.00</strong></span>
            </div>
            <div class="cost-breakdown-item">
              <span>Whisper: <strong>$0.00</strong></span>
            </div>
          </div>
        </div>
        
        <div class="recent-calls-section">
          <div class="recent-calls-label">Recent Calls</div>
          <div id="recent-calls" class="recent-calls-list">
            <div class="recent-call-placeholder">No recent activity</div>
          </div>
        </div>
      </div>
    </div>

    <!-- üìä Buttons at Bottom -->
    <div class="report-section">
      <button id="download-report-btn" class="btn-report">üìÑ Download Document Report</button>
      <button id="delete-all-btn" class="btn-delete-all" style="margin-left: 10px;">üóëÔ∏è Delete All Files</button>
    </div>
  </div>

  <!-- üí¨ Floating Chat Button -->
  <div id="chat-toggle" class="chat-toggle">üí¨</div>

  <!-- üí¨ Chat Window -->
  <div id="chat-container" class="chat-container hidden">
    <div class="chat-header">
      <span>Axis Mind Chat üìö</span>
      <button id="chat-close">√ó</button>
    </div>
    <div id="chat-log" class="chat-log"></div>
    <div class="chat-input-area">
      <input type="text" id="chatInput" placeholder="Ask anything... (searches all documents)" />
      <button id="sendBtn">Send</button>
    </div>
  </div>

  <!-- ‚ö†Ô∏è Error Notification Modal -->
  <div id="error-modal" class="error-modal hidden">
    <div class="error-modal-content">
      <div class="error-modal-header">‚ö†Ô∏è Error</div>
      <div id="error-modal-message" class="error-modal-message"></div>
      <div class="error-modal-buttons">
        <button id="error-modal-ok" class="error-modal-btn">OK</button>
      </div>
    </div>
  </div>

  <!-- üéì Training Pair Review Modal -->
  <div id="training-review-modal" class="training-review-modal hidden">
    <div class="training-review-container">
      <div class="training-review-header">
        <div class="training-review-title">
          <h2>üìù Review Training Pairs</h2>
          <span id="training-review-filename" class="training-review-filename">filename.jsonl</span>
        </div>
        <button id="training-review-close" class="training-review-close">√ó</button>
      </div>
      
      <div class="training-review-stats">
        <div class="training-review-stat">
          <span class="stat-label">Total Pairs:</span>
          <span id="training-review-total" class="stat-value">0</span>
        </div>
        <div class="training-review-stat">
          <span class="stat-label">Edited:</span>
          <span id="training-review-edited" class="stat-value">0</span>
        </div>
        <div class="training-review-stat">
          <span class="stat-label">Deleted:</span>
          <span id="training-review-deleted" class="stat-value">0</span>
        </div>
      </div>
      
      <div class="training-review-actions-top">
        <button id="training-copy-all-btn" class="btn-training-copy">
          üìã Copy All for Claude Review
        </button>
      </div>
      
      <div class="training-review-pairs" id="training-review-pairs">
        <!-- Pairs will be loaded here -->
        <div class="training-pairs-loading">Loading pairs...</div>
      </div>
      
      <div class="training-review-footer">
        <button id="training-review-cancel" class="btn-review-cancel">Cancel</button>
        <button id="training-review-approve" class="btn-review-approve">
          ‚úÖ Approve & Add to Collection
        </button>
      </div>
    </div>
  </div>

  <!-- üéì Training Pair Edit Modal -->
  <div id="training-edit-modal" class="training-edit-modal hidden">
    <div class="training-edit-container">
      <div class="training-edit-header">
        <h3>‚úèÔ∏è Edit Pair <span id="training-edit-index">#1</span></h3>
        <button id="training-edit-close" class="training-edit-close">√ó</button>
      </div>
      
      <div class="training-edit-form">
        <div class="training-edit-field">
          <label for="training-edit-question">Question:</label>
          <textarea id="training-edit-question" rows="3" placeholder="Enter the question..."></textarea>
        </div>
        <div class="training-edit-field">
          <label for="training-edit-answer">Answer:</label>
          <textarea id="training-edit-answer" rows="6" placeholder="Enter the answer..."></textarea>
        </div>
      </div>
      
      <div class="training-edit-footer">
        <button id="training-edit-cancel" class="btn-edit-cancel">Cancel</button>
        <button id="training-edit-save" class="btn-edit-save">üíæ Save Changes</button>
      </div>
    </div>
  </div>

  <script src="https://apis.google.com/js/api.js"></script>
  <script src="/static/script.js?v=40-BATCH-RETAG"></script>
  <script src="/static/youtube-import.js"></script>
  
  <!-- YouTube Import Styles -->
  <style>
    /* YouTube Import Section */
    .youtube-import-section {
      margin-top: 20px;
    }
    
    .youtube-import-toggle {
      width: 100%;
      padding: 16px 20px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.2s;
    }
    
    .youtube-import-toggle:hover {
      background: var(--bg-hover);
    }
    
    .youtube-import-toggle-content {
      display: flex;
      align-items: center;
      font-size: 15px;
      font-weight: 500;
    }
    
    .youtube-import-chevron {
      transition: transform 0.3s;
    }
    
    .youtube-import-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }
    
    .youtube-import-content.active {
      padding: 20px;
      border: 1px solid var(--border-color);
      border-top: none;
      border-radius: 0 0 12px 12px;
    }
    
    /* CSV Upload */
    .csv-upload-section {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    
    .btn-csv-upload {
      padding: 12px 24px;
      background: var(--primary-color);
      color: white;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-csv-upload:hover {
      opacity: 0.9;
    }
    
    .csv-file-name {
      color: var(--text-secondary);
      font-size: 14px;
    }
    
    .btn-import-csv {
      padding: 12px 24px;
      background: #14b8a6;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
    }
    
    .btn-import-csv:hover {
      background: #0d9488;
    }
    
    .btn-import-csv:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* Import Progress */
    .csv-import-progress {
      margin: 20px 0;
      padding: 16px;
      background: var(--bg-secondary);
      border-radius: 8px;
    }
    
    .import-status-text {
      margin-bottom: 12px;
      font-size: 14px;
    }
    
    .import-progress-bar-container {
      width: 100%;
      height: 8px;
      background: var(--bg-tertiary);
      border-radius: 4px;
      overflow: hidden;
    }
    
    .import-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #14b8a6, #06b6d4);
      transition: width 0.3s;
      width: 0%;
    }
    
    /* Match Results */
    .match-results-summary {
      margin: 20px 0;
      padding: 20px;
      background: var(--bg-secondary);
      border-radius: 12px;
    }
    
    .match-results-summary h3 {
      margin: 0 0 16px 0;
      font-size: 18px;
    }
    
    .match-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    
    .match-stat {
      padding: 16px;
      border-radius: 8px;
      text-align: center;
    }
    
    .match-stat.high-confidence {
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.3);
    }
    
    .match-stat.medium-confidence {
      background: rgba(234, 179, 8, 0.1);
      border: 1px solid rgba(234, 179, 8, 0.3);
    }
    
    .match-stat.low-confidence {
      background: rgba(249, 115, 22, 0.1);
      border: 1px solid rgba(249, 115, 22, 0.3);
    }
    
    .match-stat.unmatched {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
    }
    
    .stat-label {
      display: block;
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }
    
    .stat-value {
      display: block;
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    
    .stat-desc {
      display: block;
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    .btn-view-pending {
      width: 100%;
      padding: 12px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
    }
    
    .btn-view-pending:hover {
      opacity: 0.9;
    }
    
    /* Pending Videos */
    .pending-videos-section {
      margin-top: 20px;
      padding: 20px;
      background: var(--bg-secondary);
      border-radius: 12px;
    }
    
    .pending-videos-section h3 {
      margin: 0 0 16px 0;
    }
    
    .pending-filters {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    
    .filter-btn {
      padding: 8px 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .filter-btn.active {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }
    
    .pending-videos-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .pending-video-card {
      padding: 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
    }
    
    .video-info {
      flex: 1;
    }
    
    .video-title {
      font-weight: 500;
      margin-bottom: 8px;
    }
    
    .video-meta {
      display: flex;
      gap: 12px;
      font-size: 13px;
      color: var(--text-secondary);
    }
    
    .video-confidence.confidence-medium {
      color: #eab308;
    }
    
    .video-confidence.confidence-low {
      color: #f97316;
    }
    
    .video-confidence.confidence-unmatched {
      color: #ef4444;
    }
    
    .video-actions {
      display: flex;
      gap: 8px;
    }
    
    .btn-view-video, .btn-link-video {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      border: none;
    }
    
    .btn-view-video {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }
    
    .btn-link-video {
      background: #14b8a6;
      color: white;
    }
    
    .pagination {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      margin-top: 16px;
    }
    
    .page-btn {
      padding: 8px 16px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    
    .page-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .page-info {
      font-size: 14px;
      color: var(--text-secondary);
    }
    
    .youtube-import-status {
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 16px;
    }
    
    .youtube-import-status.error {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }
    
    .youtube-import-status.success {
      background: rgba(34, 197, 94, 0.1);
      color: #22c55e;
      border: 1px solid rgba(34, 197, 94, 0.3);
    }
    
    /* Linking Modal */
    .link-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      padding: 20px;
    }
    
    .link-modal-content {
      background: var(--bg-primary);
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 600px;
      width: 100%;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
    }
    
    .link-modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .link-modal-header h3 {
      margin: 0;
      font-size: 18px;
    }
    
    .close-modal {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: var(--text-secondary);
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
    }
    
    .close-modal:hover {
      background: var(--bg-secondary);
    }
    
    .link-modal-body {
      padding: 20px;
      flex: 1;
      overflow-y: auto;
    }
    
    .video-preview {
      padding: 16px;
      background: var(--bg-secondary);
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .preview-title {
      font-weight: 500;
      margin-bottom: 8px;
    }
    
    .preview-meta {
      font-size: 13px;
      color: var(--text-secondary);
    }
    
    .lesson-search-section {
      margin-bottom: 16px;
    }
    
    .lesson-search-section label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      font-size: 14px;
    }
    
    .lesson-search-input {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--bg-secondary);
      font-size: 14px;
    }
    
    .lessons-list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid var(--border-color);
      border-radius: 8px;
    }
    
    .lesson-option {
      padding: 12px;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .lesson-option:last-child {
      border-bottom: none;
    }
    
    .lesson-option:hover {
      background: var(--bg-secondary);
    }
    
    .lesson-option.selected {
      background: rgba(20, 184, 166, 0.1);
      border-left: 3px solid #14b8a6;
    }
    
    .lesson-option-title {
      font-weight: 500;
      margin-bottom: 4px;
    }
    
    .lesson-option-meta {
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    .loading-lessons, .no-lessons {
      padding: 40px;
      text-align: center;
      color: var(--text-secondary);
    }
    
    .link-modal-footer {
      padding: 20px;
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }
    
    .cancel-link, .confirm-link {
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      border: none;
    }
    
    .cancel-link {
      background: var(--bg-secondary);
      color: var(--text-primary);
    }
    
    .confirm-link {
      background: #14b8a6;
      color: white;
    }
    
    .confirm-link:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* === Training Pair Generator Styles === */
    .training-pairs-section {
      margin-top: 20px;
    }
    
    .training-pairs-toggle {
      width: 100%;
      padding: 16px 20px;
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(6, 182, 212, 0.1));
      border: 1px solid var(--border-color);
      border-radius: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.2s;
    }
    
    .training-pairs-toggle:hover {
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(6, 182, 212, 0.15));
    }
    
    .training-pairs-toggle-content {
      display: flex;
      align-items: center;
      font-size: 15px;
      font-weight: 600;
    }
    
    .training-pairs-chevron {
      transition: transform 0.3s;
    }
    
    .training-pairs-toggle.collapsed .training-pairs-chevron {
      transform: rotate(-90deg);
    }
    
    .training-pairs-content {
      padding: 20px;
      border: 1px solid var(--border-color);
      border-top: none;
      border-radius: 0 0 12px 12px;
      background: var(--bg-secondary);
    }
    
    .training-pairs-content.collapsed {
      display: none;
    }
    
    /* Stats Overview */
    .training-stats-overview {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 20px;
    }
    
    .training-stat-item {
      text-align: center;
      padding: 16px;
      background: var(--bg-primary);
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }
    
    .training-stat-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--primary-color);
    }
    
    .training-stat-label {
      font-size: 12px;
      color: #6b7280;
      margin-top: 4px;
    }
    
    /* Resume Section */
    .training-resume-section {
      background: rgba(234, 179, 8, 0.1);
      border: 1px solid rgba(234, 179, 8, 0.3);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
    }
    
    .training-resume-header {
      font-weight: 600;
      color: #eab308;
      margin-bottom: 12px;
    }
    
    .training-resume-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: var(--bg-primary);
      border-radius: 6px;
      margin-bottom: 8px;
    }
    
    .training-resume-info {
      flex: 1;
    }
    
    .training-resume-filename {
      font-weight: 500;
      margin-bottom: 4px;
    }
    
    .training-resume-progress {
      font-size: 13px;
      color: #6b7280;
    }
    
    .training-resume-actions {
      display: flex;
      gap: 8px;
    }
    
    .btn-resume, .btn-discard {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      border: none;
    }
    
    .btn-resume {
      background: #14b8a6;
      color: white;
    }
    
    .btn-discard {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }
    
    /* Upload Section */
    .training-upload-section {
      margin-bottom: 20px;
    }
    
    .training-description {
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 16px;
    }
    
    .training-upload-row {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    .btn-training-upload {
      padding: 12px 24px;
      background: var(--primary-color);
      color: white;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: opacity 0.2s;
    }
    
    .btn-training-upload:hover {
      opacity: 0.9;
    }
    
    .training-file-name {
      flex: 1;
      color: #6b7280;
      font-size: 14px;
      min-width: 150px;
    }
    
    .btn-training-process {
      padding: 12px 24px;
      background: linear-gradient(135deg, #8b5cf6, #06b6d4);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }
    
    .btn-training-process:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
    }
    
    .btn-training-process:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* Progress Section */
    .training-progress-section {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .training-progress-header h4 {
      margin: 0 0 16px 0;
      font-size: 16px;
    }
    
    .training-progress-stats {
      display: flex;
      gap: 24px;
      margin-bottom: 16px;
    }
    
    .training-progress-stat {
      display: flex;
      gap: 8px;
    }
    
    .training-progress-label {
      color: #6b7280;
      font-size: 14px;
    }
    
    .training-progress-value {
      font-weight: 600;
      font-size: 14px;
    }
    
    .training-progress-bar-container {
      width: 100%;
      height: 8px;
      background: var(--bg-tertiary);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 12px;
    }
    
    .training-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #8b5cf6, #06b6d4);
      width: 0%;
      transition: width 0.3s;
    }
    
    .training-progress-status {
      font-size: 13px;
      color: #6b7280;
    }
    
    /* Files Lists */
    .training-files-section {
      margin-bottom: 20px;
    }
    
    .training-files-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .training-files-header h4 {
      margin: 0;
      font-size: 15px;
    }
    
    .btn-refresh-training {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      padding: 4px 8px;
      border-radius: 4px;
    }
    
    .btn-refresh-training:hover {
      background: var(--bg-tertiary);
    }
    
    .training-files-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .training-files-placeholder {
      padding: 24px;
      text-align: center;
      color: #6b7280;
      font-size: 14px;
      background: var(--bg-primary);
      border-radius: 8px;
      border: 1px dashed var(--border-color);
    }
    
    .training-file-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      transition: background 0.2s;
    }
    
    .training-file-item:hover {
      background: var(--bg-hover);
    }
    
    .training-file-info {
      flex: 1;
    }
    
    .training-file-name-display {
      font-weight: 500;
      margin-bottom: 4px;
    }
    
    .training-file-meta {
      font-size: 13px;
      color: #6b7280;
    }
    
    .training-file-actions {
      display: flex;
      gap: 8px;
    }
    
    .btn-training-action {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      border: 1px solid var(--border-color);
      background: var(--bg-secondary);
      color: var(--text-primary);
      transition: all 0.2s;
    }
    
    .btn-training-action:hover {
      background: var(--bg-tertiary);
    }
    
    .btn-training-action.primary {
      background: #14b8a6;
      color: white;
      border-color: #14b8a6;
    }
    
    .btn-training-action.primary:hover {
      background: #0d9488;
    }
    
    .btn-training-action.danger {
      color: #ef4444;
      border-color: rgba(239, 68, 68, 0.3);
    }
    
    .btn-training-action.danger:hover {
      background: rgba(239, 68, 68, 0.1);
    }
    
    /* Download Section */
    .training-download-section {
      text-align: center;
      padding-top: 16px;
      border-top: 1px solid var(--border-color);
    }
    
    .btn-training-combine {
      padding: 14px 32px;
      background: linear-gradient(135deg, #8b5cf6, #06b6d4);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 15px;
      transition: all 0.2s;
    }
    
    .btn-training-combine:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
    }
    
    .training-download-note {
      font-size: 12px;
      color: #6b7280;
      margin-top: 12px;
    }
    
    /* === Training Pair Review Modal === */
    .training-review-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .training-review-modal.hidden {
      display: none;
    }
    
    .training-review-container {
      width: 100%;
      max-width: 900px;
      max-height: 90vh;
      background: var(--bg-primary);
      border-radius: 16px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border: 1px solid var(--border-color);
    }
    
    .training-review-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-color);
      background: var(--bg-secondary);
    }
    
    .training-review-title h2 {
      margin: 0 0 4px 0;
      font-size: 20px;
    }
    
    .training-review-filename {
      font-size: 14px;
      color: #6b7280;
      font-family: monospace;
    }
    
    .training-review-close {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: var(--text-secondary);
      padding: 0;
      line-height: 1;
    }
    
    .training-review-close:hover {
      color: var(--text-primary);
    }
    
    .training-review-stats {
      display: flex;
      gap: 24px;
      padding: 16px 24px;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border-color);
    }
    
    .training-review-stat {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .training-review-stat .stat-label {
      color: #6b7280;
      font-size: 14px;
    }
    
    .training-review-stat .stat-value {
      font-weight: 600;
      font-size: 14px;
    }
    
    .training-review-actions-top {
      padding: 16px 24px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .btn-training-copy {
      padding: 10px 20px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    
    .btn-training-copy:hover {
      background: var(--bg-tertiary);
    }
    
    .training-review-pairs {
      flex: 1;
      overflow-y: auto;
      padding: 16px 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .training-pairs-loading {
      text-align: center;
      padding: 40px;
      color: #6b7280;
    }
    
    .training-pair-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      overflow: hidden;
    }
    
    .training-pair-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border-color);
    }
    
    .training-pair-number {
      font-weight: 600;
      font-size: 14px;
      color: var(--primary-color);
    }
    
    .training-pair-actions {
      display: flex;
      gap: 8px;
    }
    
    .btn-pair-edit, .btn-pair-delete {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      border: 1px solid var(--border-color);
      background: var(--bg-primary);
      transition: all 0.2s;
    }
    
    .btn-pair-edit:hover {
      background: var(--bg-hover);
    }
    
    .btn-pair-delete {
      color: #ef4444;
      border-color: rgba(239, 68, 68, 0.3);
    }
    
    .btn-pair-delete:hover {
      background: rgba(239, 68, 68, 0.1);
    }
    
    .training-pair-content {
      padding: 16px;
    }
    
    .training-pair-question, .training-pair-answer {
      margin-bottom: 12px;
    }
    
    .training-pair-question:last-child, .training-pair-answer:last-child {
      margin-bottom: 0;
    }
    
    .training-pair-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      color: #6b7280;
      margin-bottom: 6px;
      letter-spacing: 0.5px;
    }
    
    .training-pair-text {
      font-size: 14px;
      line-height: 1.6;
      color: var(--text-primary);
    }
    
    .training-pair-question .training-pair-text {
      font-weight: 500;
    }
    
    .training-review-footer {
      display: flex;
      justify-content: space-between;
      padding: 20px 24px;
      border-top: 1px solid var(--border-color);
      background: var(--bg-secondary);
    }
    
    .btn-review-cancel, .btn-review-approve {
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }
    
    .btn-review-cancel {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }
    
    .btn-review-cancel:hover {
      background: var(--bg-hover);
    }
    
    .btn-review-approve {
      background: linear-gradient(135deg, #10b981, #14b8a6);
      color: white;
    }
    
    .btn-review-approve:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    
    /* === Training Pair Edit Modal === */
    .training-edit-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 10001;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .training-edit-modal.hidden {
      display: none;
    }
    
    .training-edit-container {
      width: 100%;
      max-width: 600px;
      background: var(--bg-primary);
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid var(--border-color);
    }
    
    .training-edit-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-color);
      background: var(--bg-secondary);
    }
    
    .training-edit-header h3 {
      margin: 0;
      font-size: 18px;
    }
    
    .training-edit-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--text-secondary);
      padding: 0;
      line-height: 1;
    }
    
    .training-edit-close:hover {
      color: var(--text-primary);
    }
    
    .training-edit-form {
      padding: 24px;
    }
    
    .training-edit-field {
      margin-bottom: 20px;
    }
    
    .training-edit-field:last-child {
      margin-bottom: 0;
    }
    
    .training-edit-field label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #6b7280;
    }
    
    .training-edit-field textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 14px;
      line-height: 1.5;
      resize: vertical;
      font-family: inherit;
    }
    
    .training-edit-field textarea:focus {
      outline: none;
      border-color: var(--primary-color);
    }
    
    .training-edit-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      padding: 20px 24px;
      border-top: 1px solid var(--border-color);
      background: var(--bg-secondary);
    }
    
    .btn-edit-cancel, .btn-edit-save {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }
    
    .btn-edit-cancel {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }
    
    .btn-edit-cancel:hover {
      background: var(--bg-hover);
    }
    
    .btn-edit-save {
      background: linear-gradient(135deg, #8b5cf6, #06b6d4);
      color: white;
    }
    
    .btn-edit-save:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
    }
    
    /* Deleted pair styling */
    .training-pair-card.deleted {
      opacity: 0.5;
      background: rgba(239, 68, 68, 0.05);
    }
    
    .training-pair-card.deleted .training-pair-header {
      background: rgba(239, 68, 68, 0.1);
    }
    
    .training-pair-card.edited .training-pair-header {
      background: rgba(139, 92, 246, 0.1);
    }
    
    .training-pair-card.edited .training-pair-number::after {
      content: " (edited)";
      font-size: 11px;
      color: #8b5cf6;
      font-weight: normal;
    }
  </style>
  
  <!-- Training Pair Generator JavaScript -->
  <script>
  (function() {
    // === Training Pair Generator ===
    const trainingToggle = document.getElementById('training-pairs-toggle');
    const trainingContent = document.getElementById('training-pairs-content');
    const trainingFileInput = document.getElementById('training-file-input');
    const trainingFileName = document.getElementById('training-file-name');
    const trainingProcessBtn = document.getElementById('training-process-btn');
    const trainingProgressSection = document.getElementById('training-progress-section');
    const trainingResumeSection = document.getElementById('training-resume-section');
    const trainingPendingList = document.getElementById('training-pending-list');
    const trainingApprovedList = document.getElementById('training-approved-list');
    const trainingCombineBtn = document.getElementById('training-combine-btn');
    const refreshBtn = document.getElementById('btn-refresh-training');
    
    let selectedFile = null;
    
    // Toggle collapse
    if (trainingToggle && trainingContent) {
      trainingToggle.classList.add('collapsed');
      trainingContent.classList.add('collapsed');
      
      trainingToggle.addEventListener('click', () => {
        trainingToggle.classList.toggle('collapsed');
        trainingContent.classList.toggle('collapsed');
        
        // Load data when opened
        if (!trainingContent.classList.contains('collapsed')) {
          loadTrainingData();
        }
      });
    }
    
    // File input handler
    if (trainingFileInput) {
      trainingFileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file && file.type === 'application/pdf') {
          selectedFile = file;
          trainingFileName.textContent = file.name;
          trainingProcessBtn.disabled = false;
        } else {
          selectedFile = null;
          trainingFileName.textContent = 'Please select a PDF file';
          trainingProcessBtn.disabled = true;
        }
      });
    }
    
    // Process button handler
    if (trainingProcessBtn) {
      trainingProcessBtn.addEventListener('click', async () => {
        if (!selectedFile) return;
        
        trainingProcessBtn.disabled = true;
        trainingProcessBtn.textContent = '‚è≥ Processing...';
        trainingProgressSection.classList.remove('hidden');
        
        document.getElementById('training-progress-filename').textContent = selectedFile.name;
        document.getElementById('training-progress-status').textContent = 'Uploading PDF...';
        document.getElementById('training-progress-bar').style.width = '10%';
        
        try {
          const formData = new FormData();
          formData.append('file', selectedFile);
          
          document.getElementById('training-progress-status').textContent = 'Extracting text and generating Q&A pairs...';
          document.getElementById('training-progress-bar').style.width = '30%';
          
          const response = await fetch('/api/training-pairs/process', {
            method: 'POST',
            body: formData
          });
          
          const result = await response.json();
          
          if (response.ok) {
            document.getElementById('training-progress-bar').style.width = '100%';
            document.getElementById('training-progress-status').textContent = 
              `‚úÖ Complete! Generated ${result.pairs_generated} pairs from ${result.chunks_processed} chunks.`;
            document.getElementById('training-progress-chunks').textContent = 
              `${result.chunks_processed} / ${result.chunks_processed}`;
            document.getElementById('training-progress-pairs').textContent = result.pairs_generated;
            
            // Refresh lists
            loadTrainingData();
            
            // Reset form
            setTimeout(() => {
              trainingProgressSection.classList.add('hidden');
              trainingFileName.textContent = 'No file selected';
              trainingFileInput.value = '';
              selectedFile = null;
              trainingProcessBtn.textContent = 'ü§ñ Generate Pairs';
              trainingProcessBtn.disabled = true;
            }, 3000);
          } else {
            throw new Error(result.error || 'Processing failed');
          }
        } catch (error) {
          console.error('Training pair error:', error);
          document.getElementById('training-progress-status').textContent = `‚ùå Error: ${error.message}`;
          document.getElementById('training-progress-bar').style.width = '100%';
          document.getElementById('training-progress-bar').style.background = '#ef4444';
          
          trainingProcessBtn.disabled = false;
          trainingProcessBtn.textContent = 'ü§ñ Generate Pairs';
        }
      });
    }
    
    // Refresh button
    if (refreshBtn) {
      refreshBtn.addEventListener('click', loadTrainingData);
    }
    
    // Combine button
    if (trainingCombineBtn) {
      trainingCombineBtn.addEventListener('click', async () => {
        trainingCombineBtn.disabled = true;
        trainingCombineBtn.textContent = '‚è≥ Combining...';
        
        try {
          const response = await fetch('/api/training-pairs/download-all');
          
          if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'training_data.jsonl';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            trainingCombineBtn.textContent = '‚úÖ Downloaded!';
            setTimeout(() => {
              trainingCombineBtn.textContent = 'üì¶ Combine All & Download';
              trainingCombineBtn.disabled = false;
            }, 2000);
          } else {
            const error = await response.json();
            throw new Error(error.error || 'Download failed');
          }
        } catch (error) {
          console.error('Download error:', error);
          alert('Download failed: ' + error.message);
          trainingCombineBtn.textContent = 'üì¶ Combine All & Download';
          trainingCombineBtn.disabled = false;
        }
      });
    }
    
    // Load training data
    async function loadTrainingData() {
      try {
        // Load stats
        const statsRes = await fetch('/api/training-pairs/stats');
        const stats = await statsRes.json();
        
        document.getElementById('training-stat-pending').textContent = stats.pending_files || 0;
        document.getElementById('training-stat-approved').textContent = stats.approved_files || 0;
        document.getElementById('training-stat-pairs').textContent = stats.total_pairs || 0;
        
        // Load in-progress files
        const inProgressRes = await fetch('/api/training-pairs/in-progress');
        const inProgress = await inProgressRes.json();
        
        if (inProgress.files && inProgress.files.length > 0) {
          trainingResumeSection.classList.remove('hidden');
          document.getElementById('training-resume-list').innerHTML = inProgress.files.map(f => `
            <div class="training-resume-item">
              <div class="training-resume-info">
                <div class="training-resume-filename">${f.source_file}</div>
                <div class="training-resume-progress">${f.completed} / ${f.total} chunks ‚Ä¢ ${f.pairs_so_far || 0} pairs</div>
              </div>
              <div class="training-resume-actions">
                <button class="btn-discard" onclick="discardTraining('${f.source_file}')">Discard</button>
              </div>
            </div>
          `).join('');
        } else {
          trainingResumeSection.classList.add('hidden');
        }
        
        // Load pending files
        const pendingRes = await fetch('/api/training-pairs/pending');
        const pending = await pendingRes.json();
        
        if (pending.files && pending.files.length > 0) {
          trainingPendingList.innerHTML = pending.files.map(f => `
            <div class="training-file-item">
              <div class="training-file-info">
                <div class="training-file-name-display">${f.filename}</div>
                <div class="training-file-meta">${f.pair_count} pairs</div>
              </div>
              <div class="training-file-actions">
                <button class="btn-training-action primary" onclick="openReviewModal('${f.filename}')">üëÅÔ∏è Review</button>
                <button class="btn-training-action" onclick="copyForReview('${f.filename}')">üìã Copy</button>
                <button class="btn-training-action danger" onclick="deleteTrainingFile('${f.filename}', 'pending')">üóëÔ∏è</button>
              </div>
            </div>
          `).join('');
        } else {
          trainingPendingList.innerHTML = '<div class="training-files-placeholder">No files pending review</div>';
        }
        
        // Load approved files
        const approvedRes = await fetch('/api/training-pairs/approved');
        const approved = await approvedRes.json();
        
        if (approved.files && approved.files.length > 0) {
          trainingApprovedList.innerHTML = approved.files.map(f => `
            <div class="training-file-item">
              <div class="training-file-info">
                <div class="training-file-name-display">${f.filename}</div>
                <div class="training-file-meta">${f.pair_count} pairs</div>
              </div>
              <div class="training-file-actions">
                <button class="btn-training-action" onclick="downloadFile('${f.filename}', 'approved')">üì• Download</button>
                <button class="btn-training-action" onclick="unapproveFile('${f.filename}')">‚Ü©Ô∏è Edit</button>
                <button class="btn-training-action danger" onclick="deleteTrainingFile('${f.filename}', 'approved')">üóëÔ∏è</button>
              </div>
            </div>
          `).join('');
        } else {
          trainingApprovedList.innerHTML = '<div class="training-files-placeholder">No approved files yet</div>';
        }
        
      } catch (error) {
        console.error('Error loading training data:', error);
      }
    }
    
    // Global functions for buttons
    window.discardTraining = async function(filename) {
      if (!confirm(`Discard progress for "${filename}"?`)) return;
      
      try {
        const response = await fetch(`/api/training-pairs/discard/${encodeURIComponent(filename)}`, {
          method: 'DELETE'
        });
        if (response.ok) {
          loadTrainingData();
        } else {
          const error = await response.json();
          alert('Error: ' + error.error);
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    };
    
    window.copyForReview = async function(filename) {
      try {
        const response = await fetch(`/api/training-pairs/clipboard/${encodeURIComponent(filename)}`);
        const data = await response.json();
        
        await navigator.clipboard.writeText(data.text);
        alert('Copied to clipboard! Paste into Claude for review.');
      } catch (error) {
        alert('Error: ' + error.message);
      }
    };
    
    window.approveFile = async function(filename) {
      try {
        const response = await fetch(`/api/training-pairs/approve/${encodeURIComponent(filename)}`, {
          method: 'POST'
        });
        if (response.ok) {
          loadTrainingData();
        } else {
          const error = await response.json();
          alert('Error: ' + error.error);
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    };
    
    window.unapproveFile = async function(filename) {
      try {
        const response = await fetch(`/api/training-pairs/unapprove/${encodeURIComponent(filename)}`, {
          method: 'POST'
        });
        if (response.ok) {
          loadTrainingData();
        } else {
          const error = await response.json();
          alert('Error: ' + error.error);
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    };
    
    window.downloadFile = async function(filename, status) {
      try {
        const response = await fetch(`/api/training-pairs/download/${encodeURIComponent(filename)}?status=${status}`);
        if (response.ok) {
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
        } else {
          const error = await response.json();
          alert('Error: ' + error.error);
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    };
    
    window.deleteTrainingFile = async function(filename, status) {
      if (!confirm(`Delete "${filename}"? This cannot be undone.`)) return;
      
      try {
        const response = await fetch(`/api/training-pairs/file/${encodeURIComponent(filename)}?status=${status}`, {
          method: 'DELETE'
        });
        if (response.ok) {
          loadTrainingData();
        } else {
          const error = await response.json();
          alert('Error: ' + error.error);
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    };
    
    // ========================================
    // Phase 5: Review & Edit Modal Functions
    // ========================================
    
    let currentReviewFilename = null;
    let currentReviewPairs = [];
    let editedPairs = new Set();
    let deletedPairs = new Set();
    let currentEditIndex = null;
    
    // Get modal elements
    const reviewModal = document.getElementById('training-review-modal');
    const editModal = document.getElementById('training-edit-modal');
    
    // Open Review Modal
    window.openReviewModal = async function(filename) {
      currentReviewFilename = filename;
      editedPairs.clear();
      deletedPairs.clear();
      
      // Show modal
      reviewModal.classList.remove('hidden');
      document.getElementById('training-review-filename').textContent = filename;
      document.getElementById('training-review-pairs').innerHTML = '<div class="training-pairs-loading">Loading pairs...</div>';
      
      // Load pairs
      await loadPairsForReview(filename);
    };
    
    // Load pairs for review
    async function loadPairsForReview(filename) {
      try {
        const response = await fetch(`/api/training-pairs/review/${encodeURIComponent(filename)}`);
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || 'Failed to load pairs');
        }
        
        currentReviewPairs = data.pairs;
        renderReviewPairs();
        updateReviewStats();
        
      } catch (error) {
        console.error('Error loading pairs:', error);
        document.getElementById('training-review-pairs').innerHTML = 
          `<div class="training-pairs-loading">Error: ${error.message}</div>`;
      }
    }
    
    // Render all pairs
    function renderReviewPairs() {
      const container = document.getElementById('training-review-pairs');
      
      if (currentReviewPairs.length === 0) {
        container.innerHTML = '<div class="training-pairs-loading">No pairs found</div>';
        return;
      }
      
      container.innerHTML = currentReviewPairs.map((pair, index) => {
        const isDeleted = deletedPairs.has(index);
        const isEdited = editedPairs.has(index);
        const cardClass = isDeleted ? 'deleted' : (isEdited ? 'edited' : '');
        
        return `
          <div class="training-pair-card ${cardClass}" data-index="${index}">
            <div class="training-pair-header">
              <span class="training-pair-number">Pair ${index + 1}</span>
              <div class="training-pair-actions">
                ${!isDeleted ? `
                  <button class="btn-pair-edit" onclick="openEditModal(${index})">‚úèÔ∏è Edit</button>
                  <button class="btn-pair-delete" onclick="deletePairFromReview(${index})">üóëÔ∏è Delete</button>
                ` : `
                  <button class="btn-pair-edit" onclick="undoDeletePair(${index})">‚Ü©Ô∏è Undo</button>
                `}
              </div>
            </div>
            <div class="training-pair-content">
              <div class="training-pair-question">
                <div class="training-pair-label">Question</div>
                <div class="training-pair-text">${escapeHtml(pair.question)}</div>
              </div>
              <div class="training-pair-answer">
                <div class="training-pair-label">Answer</div>
                <div class="training-pair-text">${escapeHtml(pair.answer)}</div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // Update stats display
    function updateReviewStats() {
      document.getElementById('training-review-total').textContent = currentReviewPairs.length;
      document.getElementById('training-review-edited').textContent = editedPairs.size;
      document.getElementById('training-review-deleted').textContent = deletedPairs.size;
    }
    
    // Open Edit Modal
    window.openEditModal = function(index) {
      currentEditIndex = index;
      const pair = currentReviewPairs[index];
      
      document.getElementById('training-edit-index').textContent = `#${index + 1}`;
      document.getElementById('training-edit-question').value = pair.question;
      document.getElementById('training-edit-answer').value = pair.answer;
      
      editModal.classList.remove('hidden');
    };
    
    // Save edited pair
    async function saveEditedPair() {
      const newQuestion = document.getElementById('training-edit-question').value.trim();
      const newAnswer = document.getElementById('training-edit-answer').value.trim();
      
      if (!newQuestion || !newAnswer) {
        alert('Both question and answer are required');
        return;
      }
      
      try {
        const response = await fetch(`/api/training-pairs/pair/${encodeURIComponent(currentReviewFilename)}?pair_index=${currentEditIndex}&question=${encodeURIComponent(newQuestion)}&answer=${encodeURIComponent(newAnswer)}`, {
          method: 'PATCH'
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to save');
        }
        
        // Update local data
        currentReviewPairs[currentEditIndex].question = newQuestion;
        currentReviewPairs[currentEditIndex].answer = newAnswer;
        editedPairs.add(currentEditIndex);
        
        // Close edit modal and re-render
        editModal.classList.add('hidden');
        renderReviewPairs();
        updateReviewStats();
        
      } catch (error) {
        alert('Error saving: ' + error.message);
      }
    }
    
    // Delete pair from review
    window.deletePairFromReview = async function(index) {
      try {
        const response = await fetch(`/api/training-pairs/pair/${encodeURIComponent(currentReviewFilename)}/${index}`, {
          method: 'DELETE'
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to delete');
        }
        
        // Mark as deleted locally (we'll re-fetch to get updated indices)
        deletedPairs.add(index);
        renderReviewPairs();
        updateReviewStats();
        
        // Reload pairs to get correct indices
        await loadPairsForReview(currentReviewFilename);
        
      } catch (error) {
        alert('Error deleting: ' + error.message);
      }
    };
    
    // Undo delete (note: this only works visually before reload)
    window.undoDeletePair = function(index) {
      deletedPairs.delete(index);
      renderReviewPairs();
      updateReviewStats();
    };
    
    // Copy all pairs for Claude review
    async function copyAllForReview() {
      try {
        const response = await fetch(`/api/training-pairs/clipboard/${encodeURIComponent(currentReviewFilename)}`);
        const data = await response.json();
        
        await navigator.clipboard.writeText(data.text);
        
        const btn = document.getElementById('training-copy-all-btn');
        const originalText = btn.textContent;
        btn.textContent = '‚úÖ Copied!';
        setTimeout(() => btn.textContent = originalText, 2000);
        
      } catch (error) {
        alert('Error copying: ' + error.message);
      }
    }
    
    // Approve file and close modal
    async function approveAndClose() {
      try {
        const response = await fetch(`/api/training-pairs/approve/${encodeURIComponent(currentReviewFilename)}`, {
          method: 'POST'
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to approve');
        }
        
        // Close modal and refresh
        closeReviewModal();
        loadTrainingData();
        
      } catch (error) {
        alert('Error approving: ' + error.message);
      }
    }
    
    // Close review modal
    function closeReviewModal() {
      reviewModal.classList.add('hidden');
      currentReviewFilename = null;
      currentReviewPairs = [];
      editedPairs.clear();
      deletedPairs.clear();
    }
    
    // Close edit modal
    function closeEditModal() {
      editModal.classList.add('hidden');
      currentEditIndex = null;
    }
    
    // Escape HTML for safe rendering
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // Event listeners for modals
    if (reviewModal) {
      document.getElementById('training-review-close').addEventListener('click', closeReviewModal);
      document.getElementById('training-review-cancel').addEventListener('click', closeReviewModal);
      document.getElementById('training-review-approve').addEventListener('click', approveAndClose);
      document.getElementById('training-copy-all-btn').addEventListener('click', copyAllForReview);
      
      // Close on background click
      reviewModal.addEventListener('click', (e) => {
        if (e.target === reviewModal) closeReviewModal();
      });
    }
    
    if (editModal) {
      document.getElementById('training-edit-close').addEventListener('click', closeEditModal);
      document.getElementById('training-edit-cancel').addEventListener('click', closeEditModal);
      document.getElementById('training-edit-save').addEventListener('click', saveEditedPair);
      
      // Close on background click
      editModal.addEventListener('click', (e) => {
        if (e.target === editModal) closeEditModal();
      });
    }
    
  })();
  </script>
</body>
</html>